<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êñá‰ª∂Â§πÂÜÖÂÆπÊü•ÁúãÂô®</title>
  <!-- Ê∑ªÂä†PDFObjectÂ∫ìÔºåÁî®‰∫éPDFÈ¢ÑËßà -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js"></script>
  <style>
    :root {
      --primary-color: #4b6cb7;
      --secondary-color: #182848;
      --accent-color: #5e72e4;
      --light-bg: #f8f9fa;
      --dark-text: #333;
      --light-text: #666;
      --border-color: #e0e0e0;
      --success-color: #2dce89;
      --warning-color: #fb6340;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark-text);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: white;
      border-radius: 15px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }

    header {
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .header-left h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header-info {
      font-size: 0.9rem;
      opacity: 0.85;
      display: flex;
      gap: 15px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .info-icon {
      font-size: 1.1rem;
    }

    .upload-area {
      position: relative;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    #folderInput {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .directory-tree {
      width: 35%;
      border-right: 1px solid var(--border-color);
      padding: 20px;
      overflow-y: auto;
      background-color: var(--light-bg);
      display: flex;
      flex-direction: column;
    }

    .tree-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .search-box {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(94, 114, 228, 0.2);
    }

    .btn {
      padding: 10px 15px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn:hover {
      background: #f0f2f5;
      border-color: #cbd0dd;
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .btn-primary:hover {
      background: #4a5fc9;
    }

    .tree {
      list-style-type: none;
      padding-left: 0;
      flex: 1;
      overflow-y: auto;
    }

    .tree li {
      position: relative;
      padding: 10px 5px 10px 35px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      margin-bottom: 3px;
    }

    .tree li:hover {
      background-color: #edf1f7;
    }

    .tree li:before {
      content: '';
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background-size: contain;
      background-position: center;
    }

    .tree li.folder:before {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234b6cb7"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>');
    }

    .tree li.file:before {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><path d="M14 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8l-6-6zm2 14H8v-2h8v2zm-3-4H8v-2h5v2zm3-4H8V8h8v2z"/></svg>');
    }

    .folder-children {
      padding-left: 25px;
      display: none;
    }

    .folder.open>.folder-children {
      display: block;
    }

    .folder>.folder-name:after {
      content: '‚ñ∂';
      position: absolute;
      left: -5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #777;
      transition: transform 0.2s;
    }

    .folder.open>.folder-name:after {
      transform: translateY(-50%) rotate(90deg);
    }

    .file.active {
      background-color: #e3eeff;
      font-weight: 500;
      color: var(--accent-color);
    }

    .file-size {
      font-size: 0.8rem;
      color: var(--light-text);
      margin-left: 8px;
      font-weight: normal;
    }

    .preview-pane {
      width: 65%;
      padding: 25px;
      background-color: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .preview-header h2 {
      font-size: 1.4rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-icon {
      font-size: 1.5rem;
    }

    .preview-content {
      margin-top: 10px;
      padding: 20px;
      border-radius: 10px;
      background-color: var(--light-bg);
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
    }

    .text-content {
      white-space: pre-wrap;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.7;
      flex: 1;
      overflow: auto;
    }

    .image-preview {
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: auto;
      box-shadow: var(--shadow);
      border-radius: 8px;
    }

    .empty-preview {
      text-align: center;
      padding: 40px;
      color: var(--light-text);
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .empty-icon {
      font-size: 4rem;
      color: #cbd0dd;
      margin-bottom: 20px;
    }

    .unsupported-file {
      text-align: center;
      padding: 50px;
      color: var(--light-text);
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .unsupported-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      color: #cbd0dd;
    }

    .file-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .pdf-preview {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .pdf-preview iframe {
      flex: 1;
      border: 1px solid #eee;
      border-radius: 8px;
      background-color: white;
      min-height: 500px;
    }

    .docx-preview {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    footer {
      text-align: center;
      padding: 15px;
      background-color: var(--light-bg);
      color: var(--light-text);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
      font-size: 0.85rem;
      color: var(--light-text);
    }

    .file-info {
      display: flex;
      gap: 15px;
    }

    @media (max-width: 992px) {
      .main-content {
        flex-direction: column;
      }

      .directory-tree,
      .preview-pane {
        width: 100%;
        height: 50%;
      }

      .directory-tree {
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(94, 114, 228, 0.2);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="header-left">
          <h1>Êñá‰ª∂Â§πÂÜÖÂÆπÊü•ÁúãÂô®</h1>
          <div class="header-info">
            <div class="info-item">
              <span class="info-icon">üìÅ</span>
              <span id="folderCount">0 ‰∏™Êñá‰ª∂Â§π</span>
            </div>
            <div class="info-item">
              <span class="info-icon">üìÑ</span>
              <span id="fileCount">0 ‰∏™Êñá‰ª∂</span>
            </div>
          </div>
        </div>
        <div class="upload-area" id="uploadArea">
          <span>üìÇ ÈÄâÊã©Êñá‰ª∂Â§π</span>
          <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>
      </div>
    </header>

    <div class="main-content">
      <div class="directory-tree">
        <div class="tree-controls">
          <input type="text" id="search" class="search-box" placeholder="ÊêúÁ¥¢Êñá‰ª∂ÊàñÊñá‰ª∂Â§π...">
          <button class="btn" id="expandAll">Â±ïÂºÄÊâÄÊúâ</button>
          <button class="btn" id="collapseAll">ÊäòÂè†ÊâÄÊúâ</button>
        </div>
        <div class="tree" id="directoryTree">
          <div class="empty-preview">
            <div class="empty-icon">üìÅ</div>
            <h3>ÈÄâÊã©Êñá‰ª∂Â§πÂºÄÂßãÊµèËßà</h3>
            <p>ÁÇπÂáªÂè≥‰∏äËßíÁöÑ"ÈÄâÊã©Êñá‰ª∂Â§π"ÊåâÈíÆÂä†ËΩΩÁõÆÂΩïÁªìÊûÑ</p>
          </div>
        </div>
      </div>

      <div class="preview-pane">
        <div class="preview-header">
          <h2 id="previewTitle">
            <span class="file-icon">üìÑ</span>
            <span>Êñá‰ª∂È¢ÑËßà</span>
          </h2>
        </div>
        <div class="preview-content" id="previewContent">
          <div class="empty-preview">
            <div class="empty-icon">üìÑ</div>
            <h3>ÈÄâÊã©Êñá‰ª∂ËøõË°åÈ¢ÑËßà</h3>
            <p>‰ªéÂ∑¶‰æßÁõÆÂΩïÊ†ë‰∏≠ÈÄâÊã©Êñá‰ª∂Êü•ÁúãÂÜÖÂÆπ</p>
          </div>
        </div>
        <div class="status-bar">
          <div class="file-info">
            <div id="fileType">Êñá‰ª∂Á±ªÂûã: -</div>
            <div id="fileSize">Â§ßÂ∞è: -</div>
            <div id="lastModified">‰øÆÊîπÊó∂Èó¥: -</div>
          </div>
          <div id="filePath">Ë∑ØÂæÑ: -</div>
        </div>
      </div>
    </div>

    <footer>
      <div>‰ΩøÁî®ËØ¥Êòé: Â∞ÜÊ≠§HTMLÊñá‰ª∂‰∏éË¶ÅÊü•ÁúãÁöÑÊñá‰ª∂Â§πÊîæÂú®Âêå‰∏ÄÁõÆÂΩï‰∏ãÔºåÁÑ∂ÂêéÊâìÂºÄHTMLÊñá‰ª∂</div>
      <div>ÊèêÁ§∫: ‰ªÖÊîØÊåÅÊñáÊú¨„ÄÅÂõæÂÉèÊñá‰ª∂ÁöÑÈ¢ÑËßàÔºåPDFÈ¢ÑËßàÂèØËÉΩÂèóÊµèËßàÂô®ÈôêÂà∂ÔºåDOCXÊñá‰ª∂ÈúÄ‰∏ãËΩΩÂêéÊü•Áúã</div>
    </footer>
  </div>

  <script>
    // ÂÖ®Â±ÄÁä∂ÊÄÅ
    const state = {
      directoryTree: null,
      currentFile: null,
      openFolders: new Set()
    };

    // DOMÂÖÉÁ¥†
    const directoryTreeEl = document.getElementById('directoryTree');
    const previewContentEl = document.getElementById('previewContent');
    const previewTitleEl = document.getElementById('previewTitle');
    const searchInput = document.getElementById('search');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    const folderInput = document.getElementById('folderInput');
    const folderCountEl = document.getElementById('folderCount');
    const fileCountEl = document.getElementById('fileCount');
    const fileTypeEl = document.getElementById('fileType');
    const fileSizeEl = document.getElementById('fileSize');
    const lastModifiedEl = document.getElementById('lastModified');
    const filePathEl = document.getElementById('filePath');

    // ‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.addEventListener('DOMContentLoaded', init);
    searchInput.addEventListener('input', handleSearch);
    expandAllBtn.addEventListener('click', expandAllFolders);
    collapseAllBtn.addEventListener('click', collapseAllFolders);
    folderInput.addEventListener('change', handleFolderSelection);

    function init () {
      // ÂàùÂßãÁä∂ÊÄÅ
      updateCounts(0, 0);
    }

    function handleFolderSelection (event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      // Ëé∑ÂèñÊñá‰ª∂Â§πË∑ØÂæÑÔºàÈÄöËøáÁ¨¨‰∏Ä‰∏™Êñá‰ª∂ÁöÑË∑ØÂæÑÊé®ÂØºÔºâ
      const firstFilePath = files[0].webkitRelativePath || files[0].name;
      const folderPath = firstFilePath.includes('/')
        ? firstFilePath.substring(0, firstFilePath.indexOf('/'))
        : '';

      // ÊûÑÂª∫ÁõÆÂΩïÊ†ë
      buildDirectoryTree(files, folderPath);

      // Êõ¥Êñ∞ËÆ°Êï∞
      const counts = countItems(state.directoryTree);
      updateCounts(counts.folders, counts.files);

      // Ê∏≤ÊüìÁõÆÂΩïÊ†ë
      renderDirectoryTree();
    }

    function buildDirectoryTree (files, basePath) {
      const tree = {
        name: basePath || 'Ê†πÁõÆÂΩï',
        path: basePath || '',
        type: 'folder',
        children: []
      };

      const folderMap = {};

      // Â§ÑÁêÜÊØè‰∏™Êñá‰ª∂
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const relativePath = file.webkitRelativePath || file.name;

        // ÁßªÈô§basePathÈÉ®ÂàÜ
        const pathParts = basePath
          ? relativePath.replace(basePath + '/', '').split('/')
          : relativePath.split('/');

        let currentLevel = tree;

        // Â§ÑÁêÜÊñá‰ª∂Â§πË∑ØÂæÑ
        for (let j = 0; j < pathParts.length - 1; j++) {
          const folderName = pathParts[j];
          const folderPath = basePath
            ? `${basePath}/${pathParts.slice(0, j + 1).join('/')}`
            : pathParts.slice(0, j + 1).join('/');

          if (!folderMap[folderPath]) {
            const newFolder = {
              name: folderName,
              path: folderPath,
              type: 'folder',
              children: []
            };

            currentLevel.children.push(newFolder);
            folderMap[folderPath] = newFolder;
            currentLevel = newFolder;
          } else {
            currentLevel = folderMap[folderPath];
          }
        }

        // Ê∑ªÂä†Êñá‰ª∂
        const fileName = pathParts[pathParts.length - 1];
        const fileObj = {
          name: fileName,
          path: relativePath,
          type: 'file',
          file: file,
          size: file.size,
          lastModified: file.lastModified
        };

        currentLevel.children.push(fileObj);
      }

      state.directoryTree = tree;
      return tree;
    }

    function renderDirectoryTree (node = state.directoryTree, parentEl = directoryTreeEl) {
      if (!node) {
        parentEl.innerHTML = '<div class="empty-preview"><div class="empty-icon">üìÅ</div><h3>Ê≤°ÊúâÂèØÊòæÁ§∫ÁöÑÂÜÖÂÆπ</h3></div>';
        return;
      }

      parentEl.innerHTML = '';

      // ÈÄíÂΩíÊ∏≤ÊüìÂáΩÊï∞
      function renderNode (node, container, level = 0) {
        const li = document.createElement('li');
        li.className = node.type;
        li.dataset.path = node.path;

        if (node.type === 'folder') {
          const isOpen = state.openFolders.has(node.path);
          if (isOpen) li.classList.add('open');

          const nameSpan = document.createElement('div');
          nameSpan.className = 'folder-name';
          nameSpan.textContent = node.name;

          li.appendChild(nameSpan);

          const childrenUl = document.createElement('ul');
          childrenUl.className = 'folder-children';

          if (isOpen) {
            childrenUl.style.display = 'block';
          }

          li.appendChild(childrenUl);

          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
          nameSpan.addEventListener('click', function (e) {
            e.stopPropagation();
            toggleFolder(node.path);
          });

          // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êËäÇÁÇπ
          if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
              renderNode(child, childrenUl, level + 1);
            });
          }
        } else {
          // Êñá‰ª∂ËäÇÁÇπ
          li.textContent = node.name;
          li.title = `Â§ßÂ∞è: ${formatFileSize(node.size)}`;

          // Ê∑ªÂä†Êñá‰ª∂Â§ßÂ∞èÊ†áÁ≠æ
          const sizeSpan = document.createElement('span');
          sizeSpan.className = 'file-size';
          sizeSpan.textContent = formatFileSize(node.size);
          li.appendChild(sizeSpan);

          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
          li.addEventListener('click', function (e) {
            e.stopPropagation();
            selectFile(node);
          });
        }

        container.appendChild(li);
      }

      // ‰ªéÊ†πËäÇÁÇπÂºÄÂßãÊ∏≤Êüì
      renderNode(node, parentEl);
    }

    function toggleFolder (path) {
      if (state.openFolders.has(path)) {
        state.openFolders.delete(path);
      } else {
        state.openFolders.add(path);
      }
      renderDirectoryTree();
    }

    function expandAllFolders () {
      if (!state.directoryTree) return;

      // ÈÄíÂΩíÊî∂ÈõÜÊâÄÊúâÊñá‰ª∂Â§πË∑ØÂæÑ
      function collectFolderPaths (node) {
        if (node.type === 'folder') {
          state.openFolders.add(node.path);
          if (node.children) {
            node.children.forEach(child => collectFolderPaths(child));
          }
        }
      }

      collectFolderPaths(state.directoryTree);
      renderDirectoryTree();
    }

    function collapseAllFolders () {
      state.openFolders.clear();
      renderDirectoryTree();
    }

    function selectFile (fileNode) {
      state.currentFile = fileNode;

      // Êõ¥Êñ∞UI
      document.querySelectorAll('.file').forEach(el => {
        el.classList.remove('active');
      });

      const fileEl = document.querySelector(`.file[data-path="${fileNode.path}"]`);
      if (fileEl) {
        fileEl.classList.add('active');
      }

      // Êõ¥Êñ∞È¢ÑËßàÊ†áÈ¢ò
      previewTitleEl.innerHTML = `
                <span class="file-icon">üìÑ</span>
                <span>${fileNode.name}</span>
            `;

      // Êõ¥Êñ∞Êñá‰ª∂‰ø°ÊÅØ
      fileTypeEl.textContent = `Êñá‰ª∂Á±ªÂûã: ${getFileType(fileNode.name)}`;
      fileSizeEl.textContent = `Â§ßÂ∞è: ${formatFileSize(fileNode.size)}`;
      lastModifiedEl.textContent = `‰øÆÊîπÊó∂Èó¥: ${new Date(fileNode.lastModified).toLocaleString()}`;
      filePathEl.textContent = `Ë∑ØÂæÑ: ${fileNode.path}`;

      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      previewContentEl.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div style="margin-left: 15px;">Ê≠£Âú®Âä†ËΩΩÊñá‰ª∂ÂÜÖÂÆπ...</div>
                </div>
            `;

      // Âä†ËΩΩÊñá‰ª∂ÂÜÖÂÆπ
      setTimeout(() => previewFile(fileNode.file), 100);
    }

    function previewFile (file) {
      const reader = new FileReader();
      const fileName = file.name.toLowerCase();

      reader.onload = function (e) {
        const content = e.target.result;

        // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ
        if (isImageFile(fileName)) {
          previewContentEl.innerHTML = `
                    <img src="${content}" class="image-preview" alt="${file.name}">
                    <div class="file-actions">
                        <button class="btn" onclick="zoomImage(1.2)">ÊîæÂ§ß</button>
                        <button class="btn" onclick="zoomImage(0.8)">Áº©Â∞è</button>
                        <button class="btn" onclick="resetImage()">ÈáçÁΩÆ</button>
                    </div>
                `;
        }
        else if (isTextFile(fileName)) {
          previewContentEl.innerHTML = `
                    <pre class="text-content">${escapeHtml(content)}</pre>
                `;
        }
        else if (isPdfFile(fileName)) {
          // PDFÊñá‰ª∂È¢ÑËßà - ‰ΩøÁî®data URLÁõ¥Êé•ÂµåÂÖ•PDFÂÜÖÂÆπ
          // Ê≥®ÊÑèÔºöcontentÂ∑≤ÁªèÊòØbase64ÁºñÁ†ÅÁöÑÊï∞ÊçÆURL

          // ÂàõÂª∫‰∏Ä‰∏™ÂîØ‰∏ÄIDÔºåÁî®‰∫éÊ†áËØÜÂΩìÂâçPDFÈ¢ÑËßà
          const pdfViewerId = 'pdf-viewer-' + Date.now();
          const pdfContainerId = 'pdf-container-' + Date.now();

          // Â∞ùËØï‰ΩøÁî®Â§öÁßçÊñπÂºèÈ¢ÑËßàPDF
          previewContentEl.innerHTML = `
            <div class="pdf-preview">
              <div id="${pdfContainerId}" style="width:100%; height:500px; overflow:auto; position:relative;">
                <!-- ÊñπÊ≥ï1: ‰ΩøÁî®iframeÂíådata URL -->
                <iframe id="${pdfViewerId}" src="${content}" width="100%" height="100%" 
                  style="border:none; display:block;" 
                  onload="checkPdfLoaded('${pdfViewerId}', '${pdfContainerId}')"
                  onerror="handlePdfError('${pdfViewerId}', '${pdfContainerId}')">
                </iframe>
                
                <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
                <div id="pdfLoading" style="position:absolute; top:0; left:0; right:0; bottom:0; 
                     background:rgba(255,255,255,0.8); display:flex; justify-content:center; 
                     align-items:center; z-index:5;">
                  <div style="text-align:center;">
                    <div class="spinner"></div>
                    <div style="margin-top:10px;">Ê≠£Âú®Âä†ËΩΩPDFÔºåËØ∑Á®çÂÄô...</div>
                  </div>
                </div>
              </div>
              
              <!-- ÂêéÂ§áÊñπÊ°àÔºöÂ¶ÇÊûúÈ¢ÑËßàÂ§±Ë¥• -->
              <div id="pdfFallback" style="display:none; text-align:center; padding:20px;">
                <div class="unsupported-file">
                  <div class="unsupported-icon">üìÑ</div>
                  <h3>PDFÈ¢ÑËßàÂèØËÉΩÂèóÂà∞ÈôêÂà∂</h3>
                  <p>Áî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•È¢ÑËßàÊú¨Âú∞PDFÊñá‰ª∂</p>
                  <p>ËØ∑Â∞ùËØï‰ª•‰∏ãÊñπÊ≥ïÔºö</p>
                  <ol style="text-align: left; margin-top: 10px; margin-bottom: 15px; display: inline-block;">
                    <li>‰∏ãËΩΩÊñá‰ª∂ÂêéÂú®Êú¨Âú∞ÊâìÂºÄ</li>
                    <li>‰ΩøÁî®Chrome„ÄÅEdgeÊàñFirefoxÊµèËßàÂô®</li>
                    <li>Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊúâÂÜÖÁΩÆÁöÑPDFÊü•ÁúãÂô®</li>
                  </ol>
                </div>
              </div>
              
              <div class="file-actions">
                <button class="btn btn-primary" onclick="downloadCurrentFile()">
                  ‰∏ãËΩΩÊñá‰ª∂
                </button>
                <button class="btn" onclick="tryAlternativePdfViewer('${content}', '${pdfContainerId}')">
                  Â∞ùËØïÂÖ∂‰ªñÈ¢ÑËßàÊñπÂºè
                </button>
              </div>
            </div>
          `;

          // Âª∂ËøüÊ£ÄÊü•PDFÈ¢ÑËßàÊòØÂê¶ÊàêÂäüÂä†ËΩΩ
          // Êàë‰ª¨‰∏çÂú®ËøôÈáåËøõË°åÊ£ÄÊü•ÔºåËÄåÊòØÈÄöËøáiframeÁöÑonloadÂíåonerror‰∫ã‰ª∂Â§ÑÁêÜ
        }
        else if (isDocxFile(fileName)) {
          // DOCXÊñá‰ª∂Â§ÑÁêÜ
          const blob = new Blob([content], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
          const url = URL.createObjectURL(blob);

          // Êèê‰æõÊ∏ÖÊô∞ÁöÑÊèêÁ§∫ÂíåÈÄâÈ°π
          previewContentEl.innerHTML = `
            <div class="docx-preview">
              <div class="unsupported-file">
                <div class="unsupported-icon">üìÑ</div>
                <h3>WordÊñáÊ°£È¢ÑËßà</h3>
                <p>ÊµèËßàÂô®Êó†Ê≥ïÁõ¥Êé•È¢ÑËßàWordÊñáÊ°£ÔºåÊÇ®ÂèØ‰ª•Ôºö</p>
                <ol style="text-align: left; margin-top: 10px; margin-bottom: 15px;">
                  <li>‰∏ãËΩΩÊñá‰ª∂ÂêéÂú®Êú¨Âú∞ÊâìÂºÄ</li>
                  <li>Â∞ÜÊñá‰ª∂‰∏ä‰º†Âà∞OneDriveÊàñGoogle DriveÂêéÈ¢ÑËßà</li>
                  <li>‰ΩøÁî®Office OnlineÊàñGoogle DocsÊâìÂºÄ</li>
                </ol>
                <div class="file-actions">
                  <button class="btn btn-primary" onclick="downloadCurrentFile()">
                    ‰∏ãËΩΩÊñá‰ª∂
                  </button>
                </div>
              </div>
            </div>
          `;
        }
        else {
          previewContentEl.innerHTML = `
                    <div class="unsupported-file">
                        <div class="unsupported-icon">üìÅ</div>
                        <h3>‰∏çÊîØÊåÅÈ¢ÑËßàÊ≠§Êñá‰ª∂Á±ªÂûã</h3>
                        <p>Êñá‰ª∂Á±ªÂûã: ${getFileType(file.name)}</p>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="downloadCurrentFile()">
                                ‰∏ãËΩΩÊñá‰ª∂
                            </button>
                        </div>
                    </div>
                `;
        }
      };

      reader.onerror = function () {
        previewContentEl.innerHTML = `
                <div class="unsupported-file">
                    <div class="unsupported-icon">‚ùå</div>
                    <h3>Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂ÂÜÖÂÆπ</h3>
                    <p>ËØ∑Á°Æ‰øùÊñá‰ª∂Êú™Ë¢´Âç†Áî®‰∏îÂÖ∑ÊúâËØªÂèñÊùÉÈôê</p>
                </div>
            `;
      };

      // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÈÄâÊã©ËØªÂèñÊñπÂºè
      if (isTextFile(fileName)) {
        reader.readAsText(file);
      } else {
        reader.readAsDataURL(file);
      }
    }

    function handleSearch (e) {
      const searchTerm = e.target.value.toLowerCase().trim();

      if (!searchTerm || !state.directoryTree) {
        renderDirectoryTree();
        return;
      }

      // ÈÄíÂΩíÊêúÁ¥¢ÂáΩÊï∞
      function searchTree (node, term) {
        if (!node) return null;

        // ÂÖãÈöÜËäÇÁÇπ‰ª•‰øùÊåÅÂéüÂßãÊï∞ÊçÆ‰∏çÂèò
        const clone = { ...node };

        if (clone.type === 'folder') {
          // ÈÄíÂΩíËøáÊª§Â≠êËäÇÁÇπ
          if (clone.children) {
            clone.children = clone.children
              .map(child => searchTree(child, term))
              .filter(child => child !== null);
          }

          // Â¶ÇÊûúÊñá‰ª∂Â§πÂêçÁß∞ÂåπÈÖçÊàñÂåÖÂê´ÂåπÈÖçÁöÑÂ≠êËäÇÁÇπÔºåÂàô‰øùÁïô
          if (clone.name.toLowerCase().includes(term)) {
            return clone;
          } else if (clone.children && clone.children.length > 0) {
            return clone;
          }
          return null;
        } else {
          // Êñá‰ª∂ËäÇÁÇπ - Â¶ÇÊûúÂêçÁß∞ÂåπÈÖçÂàô‰øùÁïô
          if (clone.name.toLowerCase().includes(term)) {
            return clone;
          }
          return null;
        }
      }

      const filteredTree = searchTree(state.directoryTree, searchTerm);
      renderDirectoryTree(filteredTree, directoryTreeEl);
    }

    function countItems (node) {
      if (!node) return { folders: 0, files: 0 };

      let folders = node.type === 'folder' ? 1 : 0;
      let files = node.type === 'file' ? 1 : 0;

      if (node.children) {
        node.children.forEach(child => {
          const counts = countItems(child);
          folders += counts.folders;
          files += counts.files;
        });
      }

      return { folders, files };
    }

    function updateCounts (folders, files) {
      folderCountEl.textContent = `${folders} ‰∏™Êñá‰ª∂Â§π`;
      fileCountEl.textContent = `${files} ‰∏™Êñá‰ª∂`;
    }

    // Êñá‰ª∂Á±ªÂûãÂà§Êñ≠ËæÖÂä©ÂáΩÊï∞
    function isImageFile (filename) {
      return /\.(jpe?g|png|gif|bmp|webp|svg)$/i.test(filename);
    }

    function isTextFile (filename) {
      return /\.(txt|html?|css|js|json|xml|md|csv|ts|jsx|tsx|php|py|java|cpp|h|log|ini|conf|bat|sh)$/i.test(filename);
    }

    function isPdfFile (filename) {
      return /\.pdf$/i.test(filename);
    }

    function isDocxFile (filename) {
      return /\.docx$/i.test(filename);
    }

    function getFileType (filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const types = {
        'jpg': 'JPEG ÂõæÂÉè',
        'jpeg': 'JPEG ÂõæÂÉè',
        'png': 'PNG ÂõæÂÉè',
        'gif': 'GIF ÂõæÂÉè',
        'bmp': '‰ΩçÂõæÂõæÂÉè',
        'webp': 'WebP ÂõæÂÉè',
        'svg': 'SVG Áü¢ÈáèÂõæÂÉè',
        'pdf': 'PDF ÊñáÊ°£',
        'txt': 'ÊñáÊú¨ÊñáÊ°£',
        'html': 'HTML ÊñáÊ°£',
        'htm': 'HTML ÊñáÊ°£',
        'css': 'CSS Ê†∑ÂºèË°®',
        'js': 'JavaScript Êñá‰ª∂',
        'json': 'JSON Êï∞ÊçÆ',
        'xml': 'XML Êï∞ÊçÆ',
        'md': 'Markdown ÊñáÊ°£',
        'csv': 'CSV Êï∞ÊçÆ',
        'ts': 'TypeScript Êñá‰ª∂',
        'jsx': 'React JSX Êñá‰ª∂',
        'tsx': 'React TSX Êñá‰ª∂',
        'php': 'PHP ËÑöÊú¨',
        'py': 'Python ËÑöÊú¨',
        'java': 'Java Ê∫êÊñá‰ª∂',
        'cpp': 'C++ Ê∫êÊñá‰ª∂',
        'h': 'C/C++ Â§¥Êñá‰ª∂',
        'log': 'Êó•ÂøóÊñá‰ª∂',
        'ini': 'ÈÖçÁΩÆÊñá‰ª∂',
        'conf': 'ÈÖçÁΩÆÊñá‰ª∂',
        'bat': 'ÊâπÂ§ÑÁêÜÊñá‰ª∂',
        'sh': 'Shell ËÑöÊú¨',
        'zip': 'ZIP ÂéãÁº©Êñá‰ª∂',
        'rar': 'RAR ÂéãÁº©Êñá‰ª∂',
        '7z': '7-Zip ÂéãÁº©Êñá‰ª∂',
        'exe': 'ÂèØÊâßË°åÊñá‰ª∂',
        'msi': 'Windows ÂÆâË£ÖÁ®ãÂ∫è',
        'doc': 'Word ÊñáÊ°£',
        'docx': 'Word ÊñáÊ°£',
        'xls': 'Excel Ë°®Ê†º',
        'xlsx': 'Excel Ë°®Ê†º',
        'ppt': 'PowerPoint ÊºîÁ§∫ÊñáÁ®ø',
        'pptx': 'PowerPoint ÊºîÁ§∫ÊñáÁ®ø'
      };

      return types[ext] || `${ext.toUpperCase()} Êñá‰ª∂`;
    }

    // Â∑•ÂÖ∑ÂáΩÊï∞
    function formatFileSize (bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml (text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ÂõæÂÉèÈ¢ÑËßàÊéßÂà∂ÂáΩÊï∞
    function zoomImage (factor) {
      const img = previewContentEl.querySelector('img');
      if (img) {
        const currentWidth = img.offsetWidth;
        img.style.width = (currentWidth * factor) + 'px';
      }
    }

    function resetImage () {
      const img = previewContentEl.querySelector('img');
      if (img) {
        img.style.width = '';
      }
    }

    // Êñá‰ª∂‰∏ãËΩΩ
    function downloadCurrentFile () {
      if (!state.currentFile) return;

      const url = URL.createObjectURL(state.currentFile.file);
      const a = document.createElement('a');
      a.href = url;
      a.download = state.currentFile.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ‰∏∫ÊåâÈíÆÊ∑ªÂä†ÂÖ®Â±ÄËÆøÈóÆ
    window.zoomImage = zoomImage;
    window.resetImage = resetImage;
    window.downloadCurrentFile = downloadCurrentFile;

    // PDFÈ¢ÑËßàÁõ∏ÂÖ≥ÂáΩÊï∞
    let pdfLoadCheckTimers = {};

    // Ê£ÄÊü•PDFÊòØÂê¶ÊàêÂäüÂä†ËΩΩ
    window.checkPdfLoaded = function (iframeId, containerId) {
      // ÁßªÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®ÔºàÂ¶ÇÊûúÊúâÔºâ
      if (pdfLoadCheckTimers[iframeId]) {
        clearTimeout(pdfLoadCheckTimers[iframeId]);
      }

      // ËÆæÁΩÆ‰∏Ä‰∏™ËÆ°Êó∂Âô®ÔºåÁªôPDFÂä†ËΩΩ‰∏Ä‰∫õÊó∂Èó¥
      pdfLoadCheckTimers[iframeId] = setTimeout(() => {
        try {
          const iframe = document.getElementById(iframeId);
          const pdfLoading = document.getElementById('pdfLoading');
          const pdfContainer = document.getElementById(containerId);
          const pdfFallback = document.getElementById('pdfFallback');

          if (iframe && pdfLoading) {
            // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
            pdfLoading.style.display = 'none';

            // Â∞ùËØïÊ£ÄÊµãiframeÊòØÂê¶Ê≠£Á°ÆÂä†ËΩΩ‰∫ÜPDF
            let pdfLoaded = false;

            try {
              // ÊñπÊ≥ï1ÔºöÊ£ÄÊü•iframeÂÜÖÂÆπ
              if (iframe.contentDocument &&
                iframe.contentDocument.body &&
                iframe.contentDocument.body.childNodes.length > 0) {
                pdfLoaded = true;
              }
            } catch (e) {
              // Ë∑®ÂüüÈîôËØØÔºåÊó†Ê≥ïËÆøÈóÆiframeÂÜÖÂÆπ
              console.log('Êó†Ê≥ïËÆøÈóÆiframeÂÜÖÂÆπÔºåÂ∞ùËØïÂÖ∂‰ªñÊ£ÄÊµãÊñπÊ≥ï');
            }

            // ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúiframeÊúâÈ´òÂ∫¶ÔºåÂèØËÉΩË°®Á§∫ÂÜÖÂÆπÂ∑≤Âä†ËΩΩ
            if (!pdfLoaded && iframe.offsetHeight > 100) {
              pdfLoaded = true;
            }

            // ÊñπÊ≥ï3ÔºöÊ£ÄÊü•iframeÊòØÂê¶ÊúâÊªöÂä®Êù°ÔºàÈÄöÂ∏∏Ë°®Á§∫PDFÂ∑≤Âä†ËΩΩÔºâ
            if (!pdfLoaded && iframe.contentWindow &&
              (iframe.contentWindow.document.body.scrollHeight > iframe.offsetHeight ||
                iframe.contentWindow.document.body.scrollWidth > iframe.offsetWidth)) {
              pdfLoaded = true;
            }

            // Â¶ÇÊûúÊ£ÄÊµãÂà∞PDFÊú™ÊàêÂäüÂä†ËΩΩÔºåÊòæÁ§∫ÂêéÂ§áÊñπÊ°à
            if (!pdfLoaded) {
              console.log('PDF‰ºº‰πéÊú™ÊàêÂäüÂä†ËΩΩÔºåÊòæÁ§∫ÂêéÂ§áÊñπÊ°à');
              if (pdfContainer) pdfContainer.style.display = 'none';
              if (pdfFallback) pdfFallback.style.display = 'block';
            } else {
              console.log('PDFÂ∑≤ÊàêÂäüÂä†ËΩΩ');
            }
          }
        } catch (e) {
          console.error('PDFÂä†ËΩΩÊ£ÄÊü•Â§±Ë¥•:', e);
        }
      }, 3000); // ÁªôPDF 3ÁßíÈíüÁöÑÊó∂Èó¥Âä†ËΩΩÔºåÂ¢ûÂä†Á≠âÂæÖÊó∂Èó¥
    };

    // Â§ÑÁêÜPDFÂä†ËΩΩÈîôËØØ
    window.handlePdfError = function (iframeId, containerId) {
      try {
        const iframe = document.getElementById(iframeId);
        const pdfContainer = document.getElementById(containerId);
        const pdfFallback = document.getElementById('pdfFallback');
        const pdfLoading = document.getElementById('pdfLoading');

        // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
        if (pdfLoading) {
          pdfLoading.style.display = 'none';
        }

        // ÊòæÁ§∫ÂêéÂ§áÊñπÊ°à
        if (pdfContainer && pdfFallback) {
          pdfContainer.style.display = 'none';
          pdfFallback.style.display = 'block';
        }
      } catch (e) {
        console.error('PDFÈîôËØØÂ§ÑÁêÜÂ§±Ë¥•:', e);
      }
    };

    // Â∞ùËØïÂÖ∂‰ªñPDFÈ¢ÑËßàÊñπÂºè (‰ΩøÁî®PDFObjectÂ∫ì)
    window.tryAlternativePdfViewer = function (pdfDataUrl, containerId) {
      const pdfContainer = document.getElementById(containerId);
      const pdfFallback = document.getElementById('pdfFallback');

      if (!pdfContainer) {
        console.error('PDFÂÆπÂô®ÂÖÉÁ¥†Êú™ÊâæÂà∞');
        return;
      }

      // ÈöêËóèÂêéÂ§áÊñπÊ°àÔºàÂ¶ÇÊûúÊòæÁ§∫ÁöÑËØùÔºâ
      if (pdfFallback) {
        pdfFallback.style.display = 'none';
      }

      // Á°Æ‰øùÂÆπÂô®ÊòØÂèØËßÅÁöÑ
      pdfContainer.style.display = 'block';

      // Ê∏ÖÁ©∫ÂÆπÂô®ÂÜÖÂÆπ
      pdfContainer.innerHTML = '';

      try {
        // Ê£ÄÊü•PDFObjectÊòØÂê¶ÂèØÁî®
        if (typeof PDFObject === 'undefined') {
          console.error('PDFObjectÂ∫ìÊú™Âä†ËΩΩ');
          throw new Error('PDFObjectÂ∫ìÊú™Âä†ËΩΩ');
        }

        // ‰ΩøÁî®PDFObjectÂ∫ìÂ∞ùËØïÂµåÂÖ•PDF
        const success = PDFObject.embed(pdfDataUrl, pdfContainer);

        // Â¶ÇÊûúÂµåÂÖ•Â§±Ë¥•ÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (!success) {
          throw new Error('PDFObjectÂµåÂÖ•Â§±Ë¥•');
        }
      } catch (e) {
        console.error('Â§áÁî®PDFÈ¢ÑËßàÂ§±Ë¥•:', e);

        // ÊòæÁ§∫ÁÆÄÂçïÁöÑÂµåÂÖ•ÊñπÂºè
        pdfContainer.innerHTML = `
          <object data="${pdfDataUrl}" type="application/pdf" width="100%" height="100%">
            <embed src="${pdfDataUrl}" type="application/pdf" width="100%" height="100%">
              <p>ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅPDFÈ¢ÑËßà„ÄÇ<a href="${pdfDataUrl}" target="_blank">ÁÇπÂáª‰∏ãËΩΩPDF</a></p>
            </embed>
          </object>
        `;
      }
    };
  </script>
</body>

</html>